import {
    Button,
    LineEdit,
    ScrollView,
    ListView,
    TabWidget,
} from "std-widgets.slint";
import { Palette, Theme } from "globals.slint";
import { ResultRow } from "components/ResultRow.slint";
import { ModernLineEdit } from "components/ModernLineEdit.slint";
import { ThemeToggle } from "components/ThemeToggle.slint";
import { SettingsDialog, AppSettings } from "components/Settings.slint";
import { PreviewPane } from "components/PreviewPane.slint";
import { FilterBar } from "components/FilterBar.slint";
import { Icon } from "components/Icon.slint";

component Spinner inherits Rectangle {
    width: 20px;
    height: 20px;
    property <angle> rotation_angle: 0deg;

    animate rotation_angle {
        duration: 1000ms;
        iteration-count: -1;
        easing: linear;
    }
    
    // Trigger animation
    init => {
        rotation_angle = 360deg;
    }
    Text {
        text: "⟳";
        font-size: 18px;
        color: Palette.current.accent_color;
        transform-rotation: root.rotation_angle;
        width: 100%;
        height: 100%;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

export struct FileItem {
    title: string,
    path: string,
    score: float,
    icon: string,
    snippet: string,
}

export component AppWindow inherits Window {
    title: "Flash Search";
    width: 900px;
    height: 600px;
    background: Palette.current.bg_color;

    // Data
    in-out property <[FileItem]> results: [];
    in-out property <bool> is_searching: false;
    in-out property <string> current_query: "";
    in-out property <string> filter_type: "All";
    in-out property <string> filter_size: "Any";
    
    // Settings
    in-out property <bool> show_settings: false;
    in-out property <AppSettings> settings: {
        theme: "auto",
        index_dirs: [],
        exclude_patterns: [],
        auto_start: false,
        minimize_to_tray: false
    };

    // Preview
    in-out property <string> selected_path: "";
    in-out property <string> preview_content: "";
    in-out property <string> preview_title: "Selected File";
    in-out property <image> preview_image;
    in-out property <bool> is_preview_loading: false;
    in-out property <string> preview_type: "none";
    in-out property <string> preview_file_size: "";
    in-out property <string> preview_modified: "";

    // Status
    in-out property <int> files_indexed: 0;
    in-out property <string> index_size: "0 MB";
    in-out property <float> content_progress: 0.0;
    in-out property <string> content_status: "Idle";
    
    // Restored properties for backend compatibility
    in-out property <float> filename_progress: 0.0;
    in-out property <string> filename_status: "Idle";
    in-out property <bool> show_progress: false;
    
    // Progress popup state
    in-out property <bool> show_progress_popup: false;
    in-out property <string> current_file: "";
    in-out property <string> current_folder: "";
    in-out property <string> eta_seconds: "";
    in-out property <string> files_per_second: "0";
    
    // Callbacks
    pure function get_filename_from_path(path: string) -> string {
        // Basic extraction for "/" or "\" depending on OS, but pure Slint is limited.
        // We can look for last slash.
        // Slint string API is limited. 
        // Better: let backend compute it or just show full path if complex.
        // Actually, Slint doesn't have `lastIndexOf`.
        // Let's pass it from backend into `preview_title` property.
        return path;
    }

    callback perform_search(string, string, string);
    callback open_file(string);
    callback save_settings(AppSettings);
    callback pick_new_folder();
    callback remove_folder(int);
    callback request_preview(string);
    callback copy_path(string);
    callback open_folder(string);
    callback rebuild_index();
    
    // U2: Search Debounce
    property <string> pending_query: "";
    property <bool> debounce_running: false;
    debounce_timer := Timer {
        interval: 300ms;
        running: debounce_running;
        triggered => {
            debounce_running = false;
            root.perform_search(pending_query, root.filter_type, root.filter_size);
        }
    }

    forward-focus: main_focus_scope;

    main_focus_scope := FocusScope {
        // U1: Keyboard Shortcuts
        key-pressed(event) => {
            if (event.text == "f" && event.modifiers.control) {
                search_input.focus_input();
                return accept;
            }
            if (event.text == "Escape") {
                // Clear search or close preview?
                if (root.selected_path != "") {
                    root.selected_path = "";
                    return accept;
                }
            }
            return reject;
        }

        VerticalLayout {
        // ---------------------------------------------------------
        // 1. TOP BAR (Header)
        // ---------------------------------------------------------
        Rectangle {
                height: 60px;
                background: Palette.current.surface_color;
            // Drop shadow or border bottom
            Rectangle {
                    y: parent.height - 1px;
                    height: 1px;
                    background: Palette.current.border_color;
                }

                HorizontalLayout {
                    padding-left: 16px;
                    padding-right: 16px;
                    spacing: 12px;
                    alignment: center; // Vertically center items

                // Logo / Icon
                Icon {
                        icon_name: "bolt";
                        size: 24px;
                        icon_color: Palette.current.accent_color;
                    }

                    // Search Input (Stretches)
                search_input := ModernLineEdit {
                        placeholder-text: "Search anything... (Ctrl+F)";
                        horizontal-stretch: 1;
                        accepted(text) => {
                        // Instant search on Enter
                        debounce_running = false;
                            root.current_query = text;
                            perform_search(text, root.filter_type, root.filter_size);
                        }
                        edited(text) => {
                            root.current_query = text;
                            root.pending_query = text;
                            debounce_running = false; // Reset
                        debounce_running = true;  // Start
                    }
                    }

                    // Actions (Right side)
                ThemeToggle {
                        toggled => {
                            Palette.is_dark = !Palette.is_dark;
                        }
                    }
                
                // Settings button
                Rectangle {
                        width: 40px;
                        height: 40px;
                        border-radius: 6px;
                        background: touch_settings.has-hover ? Palette.current.bg_color : transparent;
                        animate background { duration: 150ms; }
                        touch_settings := TouchArea {
                            clicked => {
                                show_settings = !show_settings;
                            }
                        }

                        Icon {
                            icon_name: "settings";
                            size: 20px;
                            icon_color: Palette.current.text_primary;
                        }
                    }
                }
            }

            // ---------------------------------------------------------
        // 1.5. FILTER BAR
        // ---------------------------------------------------------
        FilterBar {
                selected_type <=> root.filter_type;
                selected_size <=> root.filter_size;
                filter_changed => {
                    if (root.results.length > 0 || root.current_query != "") {
                        root.perform_search(root.current_query, root.filter_type, root.filter_size);
                    }
                }
            }

            // ---------------------------------------------------------
        // 2. RESULTS AREA (Dense List with Preview)
        // ---------------------------------------------------------
        HorizontalLayout {
            // Left side: Results List
            Rectangle {
                    clip: true;
                    horizontal-stretch: 1;
                    if results.length == 0: VerticalLayout {
                        alignment: center;
                        spacing: 16px;
                        if is_searching: VerticalLayout {
                            spacing: 8px;
                            alignment: center;
                            Spinner { }

                            Text {
                                text: "Searching...";
                                color: Palette.current.text_secondary;
                                font-size: 14px;
                                horizontal-alignment: center;
                            }
                        }
                        if !is_searching: Text {
                            text: (root.current_query == "" ? "Type to start searching" : "No results found");
                            color: Palette.current.text_secondary;
                            font-size: 14px;
                            horizontal-alignment: center;
                        }
                    }

                    ListView {

                        for data[index] in results: ResultRow {
                            title: data.title;
                            path: data.path;
                            score: data.score;
                            icon: data.icon;
                            snippet: data.snippet;
                            alternate: mod(index, 2) == 0;
                            selected: selected_path == data.path;
                            clicked => {
                                selected_path = data.path;
                                request_preview(data.path);
                            }
                        }
                    }
                }
            
            // Divider
            if selected_path != "": Rectangle {
                    width: 1px;
                    background: Palette.current.border_color;
                }
            
            // Right side: Preview Pane
            if selected_path != "": PreviewPane {
                    width: 350px;
                    file_name: preview_title;
                    file_path: selected_path;
                    content: preview_content;
                    preview_image: preview_image;
                    file_type: preview_type;
                    file_size: preview_file_size;
                    modified: preview_modified;
                    open_file => {
                        root.open_file(root.selected_path);
                    }
                    open_folder => {
                        root.open_folder(root.selected_path);
                    }
                    copy_path => {
                        root.copy_path(root.selected_path);
                    }
                }
            }

            // ---------------------------------------------------------
        // 3. STATUS BAR (Footer)
        // ---------------------------------------------------------
        Rectangle {
                height: 28px;
                background: Palette.current.surface_color;
                Rectangle {
                    y: 0;
                    height: 1px;
                    background: Palette.current.border_color;
                }

                HorizontalLayout {
                    padding-left: 12px;
                    padding-right: 12px;
                    spacing: 20px;
                
                // Scanning Status
                if content_status != "Idle": HorizontalLayout {
                        spacing: 8px;
                        Text {
                            text: "Indexed: " + Math.round(content_progress * 100) + "%";
                            color: Palette.current.accent_color;
                            font-size: 11px;
                            vertical-alignment: center;
                        }
                    // Simple progress bar
                    Rectangle {
                            width: 100px;
                            height: 8px;
                            y: (parent.height - self.height) / 2;
                            background: Palette.current.border_color;
                            border-radius: 4px;
                            Rectangle {
                                x: 0;
                                width: parent.width * content_progress;
                                height: 100%;
                                background: Palette.current.accent_color;
                                border-radius: 4px;
                            }
                        }
                    }

                    if content_status == "Idle": Text {
                        text: "Ready";
                        color: Palette.current.text_secondary;
                        font-size: 11px;
                        vertical-alignment: center;
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                    } // Spacer

                // Stats
                Text {
                        text: (root.current_query != "" ? root.results.length + " Found • " : "") + files_indexed + " Indexed";
                        color: Palette.current.text_primary;
                        font-size: 11px;
                        vertical-alignment: center;
                    }

                    Rectangle {
                        width: 1px;
                        height: 16px;
                        y: 6px;
                        background: Palette.current.border_color;
                    }

                    Text {
                        text: index_size;
                        color: Palette.current.text_primary;
                        font-size: 11px;
                        vertical-alignment: center;
                    }
                }
            }
        }
    } // End FocusScope
    
    // ---------------------------------------------------------
    // 4. STATUS INDICATOR (Bottom Right) - Clickable
    // ---------------------------------------------------------
    Rectangle {
        width: 60px;
        height: 24px;
        x: root.width - self.width - 12px;
        y: root.height - self.height - 40px;
        background: Palette.current.surface_color;
        border-radius: 12px;
        border-width: 1px;
        border-color: Palette.current.border_color;
        
        // Click to toggle popup
        TouchArea {
            clicked => {
                show_progress_popup = !show_progress_popup;
            }
        }

        HorizontalLayout {
            padding: 6px;
            spacing: 6px;
            alignment: center;
            
            // Status Dot
            if content_status == "Idle": Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: #10b981; // Green - Ready
            }
            if content_status == "Scanning": Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: #f59e0b; // Yellow - Scanning
            }
            if content_status == "Indexing": Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: #ef4444; // Red - Indexing
            }
            
            // Percentage text when active
            if content_status != "Idle": Text {
                text: Math.round(content_progress * 100) + "%";
                font-size: 10px;
                color: Palette.current.text_secondary;
            }
        }
    }
    
    // ---------------------------------------------------------
    // 5. PROGRESS POPUP (When clicked)
    // ---------------------------------------------------------
    if show_progress_popup: Rectangle {
        width: 280px;
        height: 180px;
        x: root.width - self.width - 12px;
        y: root.height - self.height - 70px;
        background: Palette.current.surface_color;
        border-radius: 8px;
        border-width: 1px;
        border-color: Palette.current.border_color;
        drop-shadow-blur: 8px;
        drop-shadow-color: #00000040;
        VerticalLayout {
            padding: 12px;
            spacing: 8px;
            
            // Header
            HorizontalLayout {
                spacing: 8px;
                Text {
                    text: "Index Status";
                    font-size: 13px;
                    font-weight: 600;
                    color: Palette.current.text_primary;
                }

                Rectangle {
                    horizontal-stretch: 1;
                }

                Rectangle {
                    width: 16px;
                    height: 16px;
                    Icon {
                        icon_name: "x";
                        size: 14px;
                        icon_color: Palette.current.text_secondary;
                    }

                    TouchArea {
                        clicked => {
                            show_progress_popup = false;
                        }
                    }
                }
            }
            
            // Progress bar
            Rectangle {
                height: 6px;
                background: Palette.current.border_color;
                border-radius: 3px;
                Rectangle {
                    width: parent.width * content_progress;
                    height: 100%;
                    background: Palette.current.accent_color;
                    border-radius: 3px;
                }
            }
            
            // Stats row
            HorizontalLayout {
                spacing: 12px;
                VerticalLayout {
                    Text {
                        text: "PROGRESS";
                        font-size: 9px;
                        color: Palette.current.text_secondary;
                    }

                    Text {
                        text: files_indexed + " files";
                        font-size: 11px;
                        color: Palette.current.text_primary;
                    }
                }

                VerticalLayout {
                    Text {
                        text: "SPEED";
                        font-size: 9px;
                        color: Palette.current.text_secondary;
                    }

                    Text {
                        text: files_per_second + "/s";
                        font-size: 11px;
                        color: Palette.current.text_primary;
                    }
                }

                VerticalLayout {
                    Text {
                        text: "ETA";
                        font-size: 9px;
                        color: Palette.current.text_secondary;
                    }

                    Text {
                        text: eta_seconds;
                        font-size: 11px;
                        color: Palette.current.text_primary;
                    }
                }
            }
            
            // Current file
            if current_file != "": Text {
                text: current_file;
                font-size: 10px;
                color: Palette.current.accent_color;
                overflow: elide;
            }
            
            // Current folder
            if current_folder != "": Text {
                text: current_folder;
                font-size: 10px;
                color: Palette.current.text_secondary;
                overflow: elide;
            }
            
            // Action button
            if content_status == "Idle": Button {
                text: "Rebuild Index";
                height: 28px;
                clicked => {
                    root.rebuild_index();
                }
            }
        }
    }

    // ---------------------------------------------------------
    // 6. SETTINGS DIALOG
    // ---------------------------------------------------------
    if show_settings: Rectangle {
        background: #00000080; // Dim background
        TouchArea {
            clicked => {
                show_settings = false;
            }
        }

        SettingsDialog {
            width: 600px;
            height: 500px;
            settings: root.settings;
            close => {
                show_settings = false;
            }
            save(s) => {
                root.save_settings(s);
                show_settings = false;
            }
            add_folder => {
                root.pick_new_folder();
            }
            remove_folder(i) => {
                root.remove_folder(i);
            }
            
            // Stop propagation of clicks to the dimmer
            TouchArea { }
        }
    }
}
