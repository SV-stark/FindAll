import { Button, LineEdit, ScrollView, ListView, TabWidget } from "std-widgets.slint";
import { Palette, Theme } from "globals.slint";
import { ResultRow } from "components/ResultRow.slint";
import { ModernLineEdit } from "components/ModernLineEdit.slint";
import { ThemeToggle } from "components/ThemeToggle.slint";

export struct FileItem {
    title: string,
    path: string,
    score: float,
}

export component AppWindow inherits Window {
    title: "Flash Search";
    width: 900px;
    height: 600px;
    background: Palette.current.bg_color;

    // Data
    in-out property <[FileItem]> results: [];
    in-out property <bool> is_searching: false;
    
    // Status
    in-out property <int> files_indexed: 0;
    in-out property <string> index_size: "0 MB";
    in-out property <float> content_progress: 0.0;
    in-out property <string> content_status: "Idle";
    
    // Restored properties for backend compatibility
    in-out property <float> filename_progress: 0.0;
    in-out property <string> filename_status: "Idle";
    in-out property <bool> show_progress: false;
    
    // Progress popup state
    in-out property <bool> show_progress_popup: false;
    in-out property <string> current_file: "";
    in-out property <string> current_folder: "";
    in-out property <string> eta_seconds: "";
    in-out property <string> files_per_second: "0";
    
    // Callbacks
    callback perform_search(string);
    callback open_file(string);

    VerticalLayout {
        // ---------------------------------------------------------
        // 1. TOP BAR (Header)
        // ---------------------------------------------------------
        Rectangle {
            height: 60px;
            background: Palette.current.surface_color;
            // Drop shadow or border bottom
            Rectangle {
                y: parent.height - 1px;
                height: 1px;
                background: Palette.current.border_color;
            }

            HorizontalLayout {
                padding-left: 16px;
                padding-right: 16px;
                spacing: 12px;
                alignment: center; // Vertically center items

                // Logo / Icon
                Text {
                    text: "⚡";
                    font-size: 20px;
                    vertical-alignment: center;
                }

                // Search Input (Stretches)
                ModernLineEdit {
                    placeholder-text: "Search anything...";
                    horizontal-stretch: 1;
                    accepted(text) => { perform_search(text); }
                }

                // Actions (Right side)
                ThemeToggle {
                    toggled => { Palette.is_dark = !Palette.is_dark; }
                }
                
                // Settings button placeholder
                Rectangle {
                    width: 40px;
                    height: 40px;
                    border-radius: 6px;
                    Text { 
                        text: "⚙️"; 
                        font-size: 18px; 
                        vertical-alignment: center; 
                        horizontal-alignment: center; 
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // 2. RESULTS AREA (Dense List)
        // ---------------------------------------------------------
        Rectangle {
            clip: true; // clip content
            
            if results.length == 0 : VerticalLayout {
                alignment: center;
                spacing: 16px;
                Text {
                    text: is_searching ? "Searching..." : "Type to start searching";
                    color: Palette.current.text_secondary;
                    font-size: 14px;
                    horizontal-alignment: center;
                }
            }

            ListView {
                padding-top: 4px;
                padding-bottom: 4px;
                for data[index] in results : ResultRow {
                    title: data.title;
                    path: data.path;
                    score: data.score;
                    alternate: mod(index, 2) == 0;
                    clicked => { open_file(data.path); }
                }
            }
        }

        // ---------------------------------------------------------
        // 3. STATUS BAR (Footer)
        // ---------------------------------------------------------
        Rectangle {
            height: 28px;
            background: Palette.current.surface_color;
             Rectangle {
                y: 0;
                height: 1px;
                background: Palette.current.border_color;
            }

            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                spacing: 20px;
                
                // Scanning Status
                if content_status != "Idle" : HorizontalLayout {
                    spacing: 8px;
                    Text { 
                        text: "Indexed: " + Math.round(content_progress * 100) + "%"; 
                        color: Palette.current.accent_color; 
                        font-size: 11px;
                        vertical-alignment: center;
                    }
                    // Simple progress bar
                    Rectangle {
                        width: 100px;
                        height: 8px;
                        y: (parent.height - self.height) / 2;
                        background: Palette.current.border_color;
                        border-radius: 4px;
                        Rectangle {
                            x: 0;
                            width: parent.width * content_progress;
                            height: 100%;
                            background: Palette.current.accent_color;
                            border-radius: 4px;
                        }
                    }
                }

                if content_status == "Idle" : Text {
                    text: "Ready";
                    color: Palette.current.text_secondary;
                    font-size: 11px;
                    vertical-alignment: center;
                }
                
                Rectangle { horizontal-stretch: 1; } // Spacer

                // Stats
                Text {
                    text: files_indexed + " Objects";
                    color: Palette.current.text_primary;
                    font-size: 11px;
                    vertical-alignment: center;
                }
                
                Rectangle { width: 1px; height: 16px; y: 6px; background: Palette.current.border_color; }

                Text {
                    text: index_size;
                    color: Palette.current.text_primary;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }
    }
    
    // ---------------------------------------------------------
    // 4. STATUS INDICATOR (Bottom Right) - Clickable
    // ---------------------------------------------------------
    Rectangle {
        width: 60px;
        height: 24px;
        x: root.width - self.width - 12px;
        y: root.height - self.height - 40px;
        background: Palette.current.surface_color;
        border-radius: 12px;
        border-width: 1px;
        border-color: Palette.current.border_color;
        
        // Click to toggle popup
        TouchArea {
            clicked => { show_progress_popup = !show_progress_popup; }
        }
        
        HorizontalLayout {
            padding: 6px;
            spacing: 6px;
            alignment: center;
            
            // Status Dot
            if content_status == "Idle" : Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: #10b981; // Green - Ready
            }
            
            if content_status == "Scanning" : Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: #f59e0b; // Yellow - Scanning
            }
            
            if content_status == "Indexing" : Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: #ef4444; // Red - Indexing
            }
            
            // Percentage text when active
            if content_status != "Idle" : Text {
                text: Math.round(content_progress * 100) + "%";
                font-size: 10px;
                color: Palette.current.text_secondary;
            }
        }
    }
    
    // ---------------------------------------------------------
    // 5. PROGRESS POPUP (When clicked)
    // ---------------------------------------------------------
    if show_progress_popup : Rectangle {
        width: 280px;
        height: 180px;
        x: root.width - self.width - 12px;
        y: root.height - self.height - 70px;
        background: Palette.current.surface_color;
        border-radius: 8px;
        border-width: 1px;
        border-color: Palette.current.border_color;
        drop-shadow-blur: 8px;
        drop-shadow-color: #00000040;
        
        VerticalLayout {
            padding: 12px;
            spacing: 8px;
            
            // Header
            HorizontalLayout {
                spacing: 8px;
                Text {
                    text: "Index Status";
                    font-size: 13px;
                    font-weight: 600;
                    color: Palette.current.text_primary;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "x";
                    font-size: 14px;
                    color: Palette.current.text_secondary;
                    TouchArea { clicked => { show_progress_popup = false; } }
                }
            }
            
            // Progress bar
            Rectangle {
                height: 6px;
                background: Palette.current.border_color;
                border-radius: 3px;
                Rectangle {
                    width: parent.width * content_progress;
                    height: 100%;
                    background: Palette.current.accent_color;
                    border-radius: 3px;
                }
            }
            
            // Stats row
            HorizontalLayout {
                spacing: 12px;
                
                VerticalLayout {
                    Text {
                        text: "PROGRESS";
                        font-size: 9px;
                        color: Palette.current.text_secondary;
                    }
                    Text {
                        text: files_indexed + " files";
                        font-size: 11px;
                        color: Palette.current.text_primary;
                    }
                }
                
                VerticalLayout {
                    Text {
                        text: "SPEED";
                        font-size: 9px;
                        color: Palette.current.text_secondary;
                    }
                    Text {
                        text: files_per_second + "/s";
                        font-size: 11px;
                        color: Palette.current.text_primary;
                    }
                }
                
                VerticalLayout {
                    Text {
                        text: "ETA";
                        font-size: 9px;
                        color: Palette.current.text_secondary;
                    }
                    Text {
                        text: eta_seconds;
                        font-size: 11px;
                        color: Palette.current.text_primary;
                    }
                }
            }
            
            // Current file
            if current_file != "" : Text {
                text: current_file;
                font-size: 10px;
                color: Palette.current.accent_color;
                overflow: elide;
            }
            
            // Current folder
            if current_folder != "" : Text {
                text: current_folder;
                font-size: 10px;
                color: Palette.current.text_secondary;
                overflow: elide;
            }
            
            // Action button
            if content_status == "Idle" : Button {
                text: "Rebuild Index";
                height: 28px;
            }
        }
    }
}

