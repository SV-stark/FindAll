import { Button, CheckBox, ComboBox, ScrollView, ListView, TabWidget, LineEdit, StandardListView } from "std-widgets.slint";
import { Palette, Theme } from "../globals.slint";

export struct AppSettings {
    // General
    theme: string, // "auto", "light", "dark"
    
    // Indexing
    index_dirs: [string],
    exclude_patterns: [string],
    
    // Behavior
    auto_start: bool,
    minimize_to_tray: bool,
}

export component SettingsDialog inherits Rectangle {
    in-out property <AppSettings> settings;
    callback close();
    callback save(AppSettings);
    callback add_folder();
    callback remove_folder(int);
    
    // State to track modified settings
    property <AppSettings> draft_settings: root.settings;

    background: Palette.current.surface_color;
    border-radius: 8px;
    border-width: 1px;
    border-color: Palette.current.border_color;
    
    // Prevent clicks from passing through
    TouchArea {}

    VerticalLayout {
        padding: 24px;
        spacing: 16px;

        Text {
            text: "Settings";
            font-size: 20px;
            font-weight: 700;
            color: Palette.current.text_primary;
        }

        TabWidget {
            Tab {
                title: "General";
                VerticalLayout {
                    padding: 16px;
                    spacing: 16px;
                    alignment: start;
                    
                    HorizontalLayout {
                        spacing: 16px;
                        Text {
                            text: "Theme:";
                            vertical-alignment: center;
                            color: Palette.current.text_primary;
                            width: 100px;
                        }
                        ComboBox {
                            model: ["Auto", "Light", "Dark"];
                            current-value: "Auto"; // Default, should bind to settings.theme
                            selected => {
                                if (self.current-value == "Auto") { draft_settings.theme = "auto"; }
                                if (self.current-value == "Light") { draft_settings.theme = "light"; }
                                if (self.current-value == "Dark") { draft_settings.theme = "dark"; }
                            }
                        }
                    }

                    HorizontalLayout {
                         spacing: 16px;
                         CheckBox {
                             text: "Start on Boot";
                             checked: draft_settings.auto_start;
                             toggled => { draft_settings.auto_start = self.checked; }
                         }
                    }

                    HorizontalLayout {
                         spacing: 16px;
                         CheckBox {
                             text: "Minimize to Tray";
                             checked: draft_settings.minimize_to_tray;
                             toggled => { draft_settings.minimize_to_tray = self.checked; }
                         }
                    }
                }
            }

            Tab {
                title: "Indexing";
                VerticalLayout {
                    padding: 16px;
                    spacing: 16px;
                    
                    Text {
                        text: "Indexed Directories";
                        font-weight: 600;
                        color: Palette.current.text_primary;
                    }

                    Rectangle {
                        background: Palette.current.bg_color;
                        border-color: Palette.current.border_color;
                        border-width: 1px;
                        height: 150px;
                        
                        ListView {
                            for folder[i] in draft_settings.index_dirs : HorizontalLayout {
                                padding: 8px;
                                spacing: 8px;
                                Text {
                                    text: folder;
                                    color: Palette.current.text_primary;
                                    vertical-alignment: center;
                                    horizontal-stretch: 1;
                                    overflow: elide;
                                }
                                Button {
                                    text: "Remove";
                                    clicked => { remove_folder(i); } // Need logic to remove from draft
                                }
                            }
                        }
                    }

                    Button {
                        text: "Add Folder";
                        clicked => { add_folder(); }
                    }
                }
            }
            
            Tab {
                title: "Exclusions";
                 VerticalLayout {
                    padding: 16px;
                    spacing: 16px;
                    
                    Text {
                         text: "Excluded Patterns (glob)";
                         font-weight: 600;
                         color: Palette.current.text_primary;
                    }
                    
                    Rectangle {
                        background: Palette.current.bg_color;
                        border-color: Palette.current.border_color;
                        border-width: 1px;
                        height: 150px;
                        
                        ListView {
                            for pattern in draft_settings.exclude_patterns : HorizontalLayout {
                                padding: 4px;
                                Text {
                                    text: pattern;
                                    color: Palette.current.text_primary;
                                }
                            }
                        }
                    }
                 }
            }
        }

        HorizontalLayout {
            alignment: end;
            spacing: 12px;
            
            Button {
                text: "Cancel";
                clicked => { close(); }
            }
            
            Button {
                text: "Save";
                primary: true;
                clicked => { save(draft_settings); }
            }
        }
    }
}
